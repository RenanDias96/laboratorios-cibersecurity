# üß¨ An√°lise Est√°tica de Malware ‚Äî AgentTesla (.NET)

üìÖ **Data da an√°lise:** 26/05/2025 
üìÑ Documento criado por **Renan D M** 
üîé Estudo pr√°tico com foco em extra√ß√£o de caracter√≠sticas, uso de ferramentas est√°ticas e cria√ß√£o de regra YARA personalizada.

---

## üì• 1. Coleta da Amostra no Malware Bazaar

- Pesquise por: `signature:AgentTesla`
- Escolha uma das amostras mais recentes:
                                                       
![MalwareBazaar](prints/1.png)

- Sample escolhida: [`Csomagk√∂vet√©s.exe`](https://bazaar.abuse.ch/sample/6a05709a01c5ce8f80c6f68d1a37553fbd231a6029422fcbf36cbc4a9917effc/)
 
**Hash:** `6a05709a01c5ce8f80c6f68d1a37553fbd231a6029422fcbf36cbc4a9917effc`  
**Fam√≠lia:** AgentTesla  
**Tamanho:** 931 KB


![Escolha da sample](prints/2.png)
![Download](prints/3.png)

---

## üõ∞Ô∏è 2. Isolamento do Ambiente

- Desconecte a internet da VM (rede NAT desativada)
![Network VM](prints/4.png)
- Verifique com:
```bash
ping www.google.com
```
![Ping](prints/5.png)


## üìÅ 3. Prepara√ß√£o da Sample
Renomeie para sample1.exe

Extraia o zip para ~/Desktop/lab-yara/samples
(Senha: infected)

![Extra√ß√£o](prints/6.png)

## üîç 4. An√°lise com DIE (Detect It Easy)
Abertura no DIE:

![Die](prints/7.png)

## Resultado:

- Linguagem: C

- Compilador: MS C++

- Packer: NSIS / Obfuscado

- Strings ocultas, poss√≠vel empacotamento.

## üêª 5. An√°lise com PE-bear (Imports)
Acesse a aba Import Table

![PE-Bear](prints/8.png)
![Imports](prints/9.png)

### DLLs Identificadas:

- kernel32.dll

- advapi32.dll

- user32.dll

- shell32.dll

### Fun√ß√µes suspeitas:

- AdjustTokenPrivileges, ShellExecuteExW, CreateProcessW, WritePrivateProfileW

- LookupPrivilegeValueW, GetPrivateProfileW, RegCreateKeyExA, GetCommandLineW, ShGetSpecialFolderLocation

## üß† 6. Teste com FLOSS

```bash
floss sample1.exe
```

- Resultado: apenas refer√™ncias ao NSIS. Sem strings √∫teis.

![Floss](prints/10.png)

## üìú 7. Teste com strings

```bash
strings sample1.exe > ~/Desktop/lab-yara/outputs/sample1.txt
```

- Resultado: extremamente gen√©ricas e pouco √∫teis.

![Strings](prints/11.png)

## ‚öôÔ∏è 8. Cria√ß√£o da Regra YARA
Baseada exclusivamente nos imports extra√≠dos com PE-bear:

```bash
rule Detectar_DotNEt_PowerShellScripts_PrivEsc_obf
{
    meta:
        autor = "Renan D M"
        descricao = "Detectar tentativas de execu√ß√£o de scripts, eleva√ß√£o de privil√©gios, evas√£o e obfusca√ß√£o de arquivos em .NET - MITRE ATT&CK: PowerShell (T1086), Obfuscated Files or Information (T1027), Hide Artifacts (T1564), Command and Scripting Interpreter (T1059), Privilege Escalation (T1134) e Persistence (T1543)"
        data = "26/05/2025"

    strings:

        // DLLs
        $dll1 = "shell32.dll" nocase wide ascii
        $dll2 = "user32.dll" nocase wide ascii
        $dll3 = "advapi32.dll" nocase wide ascii
        $dll4 = "kernel32.dll" nocase wide ascii

        // Escala de privil√©gios (T1134)
        $priv1 = "AdjustTokenPrivileges" nocase wide ascii
        $priv2 = "LookupPrivilegeValue" nocase wide ascii

        // Comandos PowerShell (T1086)
        $shell1 = "ShellExecute" nocase wide ascii
        $shell2 = "ShGetSpecialFolderLocation" nocase wide ascii
        $shell3 = "SHFileOperation" nocase wide ascii
        $shell4 = "SHBrowseForFolder" nocase wide ascii

        // Evas√£o e obfusca√ß√£o (T1027) e Oculta√ß√£o (T1564)
        $ev1 = "WritePrivateProfile" nocase wide ascii
        $ev2 = "GetPrivateProfile" nocase wide ascii
        $ev3 = "GetSystemDirectory" nocase wide ascii

        // Execu√ß√£o de comandos (T1059) e Persist√™ncia (T1543)
        $exec1 = "GetCommandLine" nocase wide ascii
        $exec2 = "CreateProcess" nocase wide ascii
        $exec3 = "RegCreateKey" nocase wide ascii 
        $exec4 = "RegEnumValue" nocase wide ascii

    condition:

        //Magic Number MZ encontrado com o PE-Bear
        uint16(0) == 0x5A4D and 
        //Arquivos menores que 2mb
        filesize < 2MB and
        //utilizar 2 dos $priv* e 2 dos $exec* ou
        (2 of ($priv*) and 2 of ($exec*)) or 
        //3 dos $exec*, $priv* e $env* e qualquer uma das $dll*
        (3 of ($exec*, $priv*, $ev*, $shell*) and any of ($dll*))

}
```
![Regra Yara](prints/12.png)

## üß™ 9. Teste da Regra
Salve como: ~/Desktop/lab-yara/regras/regra_detectar_DotNet.yar

```bash
yara ~/Desktop/lab-yara/regras/regra_detectar_DotNet.yar ~/Desktop/lab-yara/samples/
```

Resultado esperado:

```bash
Detectar_DotNEt_PowerShellScripts_PrivEsc_obf /home/vboxuser/lab-yara/samples/sample1.exe
```

![Resultado](prints/13.png)

## üß© 10. Refer√™ncia MITRE ATT&CK
- [`T1059`](https://attack.mitre.org/techniques/T1059/) ‚Äì Command and Scripting Interpreter  
- [`T1027`](https://attack.mitre.org/techniques/T1027/) ‚Äì Obfuscated Files or Information  
- [`T1543`](https://attack.mitre.org/techniques/T1543/) ‚Äì Create or Modify System Process  
- [`T1134`](https://attack.mitre.org/techniques/T1134/) ‚Äì Access Token Manipulation  
- [`T1086`](https://attack.mitre.org/techniques/T1086/) ‚Äì PowerShell  
- [`T1564`](https://attack.mitre.org/techniques/T1564/) ‚Äì Hide Artifacts


## üó£Ô∏è 11. Considera√ß√µes Finais
- Primeira regra YARA criada do zero, sem ajuda externa.

- Sample moderna e altamente ofuscada.

- FLOSS e strings n√£o retornaram dados √∫teis.

- PE-bear foi essencial para an√°lise de imports.

- Utiliza√ß√£o do MITRE ATT&CK para classifica√ß√£o dos comportamentos suspeitos.

- DIE indicava compatibilidade com Windows XP, mas sample roda em Win10 (confirmado via AnyRun).

- Pr√≥ximos labs focar√£o em deobfusca√ß√£o e integra√ß√£o com ambientes reais (SIEM, sandbox, etc).


